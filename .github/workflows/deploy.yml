<<<<<<< HEAD
name: Auto SSH Test on Push
=======
name: Deploy to VPS via SSH
>>>>>>> bae01b4 (Changes)

on:
  push:
    branches:
<<<<<<< HEAD
      - main  # jab bhi main branch me push ho, workflow run hoga

jobs:
  ssh-test:
    runs-on: ubuntu-latest

    steps:
=======
      - main  # triggers on push to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2️⃣ Setup SSH key
>>>>>>> bae01b4 (Changes)
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

<<<<<<< HEAD
      - name: Test SSH Connection
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            echo 'SSH Connection Successful'
            hostname
            whoami
            echo 'Server ready for deployment test'
=======
      # 3️⃣ Deploy via SSH
      - name: Deploy to Server
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            set -e

            echo 'Connected to server'

            # Directories
            APP_DIR='/var/www/app'
            RELEASES_DIR=\"\$APP_DIR/releases\"
            CURRENT_DIR=\"\$APP_DIR/current\"
            TIMESTAMP=\$(date +'%Y%m%d%H%M%S')
            NEW_RELEASE_DIR=\"\$RELEASES_DIR/\$TIMESTAMP\"

            # Create releases dir if missing
            mkdir -p \$RELEASES_DIR
            mkdir -p \$NEW_RELEASE_DIR

            echo 'Starting rsync deployment...'
          "

          # Rsync code to the new release folder
          rsync -az --delete --exclude='.git' ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/app/releases/${{ github.run_id }}/

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            set -e

            RELEASES_DIR='/var/www/app/releases'
            CURRENT_DIR='/var/www/app/current'

            # Symlink current to new release
            ln -sfn \$RELEASES_DIR/${{ github.run_id }} \$CURRENT_DIR

            # Restart service
            sudo systemctl restart myapp

            echo 'Deployment complete. Current release: \$CURRENT_DIR'

            # Keep only last 5 releases
            cd \$RELEASES_DIR
            ls -1dt */ | tail -n +6 | xargs -r rm -rf
            echo 'Old releases cleaned up, keeping last 5.'
>>>>>>> bae01b4 (Changes)
          "
