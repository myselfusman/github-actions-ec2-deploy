name: Deploy Release (Auto Activate)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2️⃣ Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 3️⃣ Create Release Directory
      - name: Create Release
        run: |
          RELEASE_NAME=$(date +'%Y%m%d%H%M%S')
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV

          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            mkdir -p /var/www/app/releases/$RELEASE_NAME
          "

      # 4️⃣ Rsync Code to New Release
      - name: Rsync Files
        run: |
          rsync -az --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/app/releases/${{ env.RELEASE_NAME }}/

      # 5️⃣ Build, Activate Symlink, Restart App
      - name: Build & Activate Release
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            set -e
            cd /var/www/app/releases/${{ env.RELEASE_NAME }}

            echo 'Installing dependencies...'
            npm install --production

            echo 'Building Next.js app...'
            npm run build

            echo 'Switching symlink to new release...'
            ln -sfn /var/www/app/releases/${{ env.RELEASE_NAME }} /var/www/app/current

            echo 'Restarting app with PM2...'
            pm2 restart myapp || pm2 start npm --name myapp -- start

            echo 'Deployment finished successfully'
          "

      # 6️⃣ Cleanup Old Releases (keep last 5)
      - name: Cleanup Old Releases
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
            cd /var/www/app/releases
            ls -1dt */ | tail -n +6 | xargs rm -rf
          "
